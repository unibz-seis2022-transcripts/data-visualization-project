---
title: "Inside Airbnb Berlin"
author: "Linus Scheibe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(sf)
library(units)
```

```{r}
sf_use_s2(FALSE)
neighbourhoods_url = "data/neighbourhoods-09-2022.geojson"
berlin_neighbourhoods <- st_read(neighbourhoods_url) %>%
  drop_na(c("neighbourhood", "neighbourhood_group"))
```

```{r}
listings_url <- "data/listings-09-2022.csv"
listings_raw <-read_csv(listings_url)
listings_price_cleaned <- listings_raw %>%
  mutate(neighbourhood=neighbourhood_cleansed) %>%
  mutate(neighbourhood_group=neighbourhood_group_cleansed) %>%
  mutate(price = str_remove_all(price, "[$,]")) %>%
  mutate(price = as.double(price))
```

```{r}
wrapper <- function(x, ...) 
{
  paste(strwrap(x, ...), collapse = "\n")
}
```

# Which are the 5 most expensive neighbourhoods and why?

```{r}
summarise_listings_by_neighbourhood <- function(listings) {
  listings %>%
    group_by(neighbourhood) %>%
    summarise(
      count_listings=n(),
      count_reviews=sum(number_of_reviews), 
      avg_price = mean(price), 
      median_price = median(price)
    )
}

listings_grouped_by_neighbourhood <- summarise_listings_by_neighbourhood(listings_price_cleaned)
```

```{r}
neighbourhoods_aggregated <- listings_grouped_by_neighbourhood %>%
  inner_join(berlin_neighbourhoods, by= "neighbourhood") %>%
  st_as_sf()
```

```{r}
neighbourhoods_aggregated %>%
  ggplot() +
  geom_sf(aes(fill = avg_price), color = "white", size = 0.2) +
  scale_fill_viridis_c() +
  ggtitle("Berlin neighbourhoods and their average price") +
  labs(fill = "Average price in $")
```

Interesting observations: Surprisingly Marzahn-Süd has a high average price, but also other areas like Marzahn-Nord, Rummelsburg and Haselhorst. Let's use ntile binning for better comparability

```{r}
neighbourhoods_top_5_avg_price <- neighbourhoods_aggregated %>%
  top_n(5, avg_price) %>%
  select(c("neighbourhood", "neighbourhood_group", "avg_price")) %>%
  mutate(is_expensive = TRUE) %>%
  st_drop_geometry()
neighbourhoods_top_5_avg_price
```

```{r}
neighbourhoods_aggregated %>%
  left_join(neighbourhoods_top_5_avg_price, by = "neighbourhood") %>%
  mutate(is_expensive = ifelse(is.na(is_expensive), FALSE, TRUE )) %>%
  ggplot() +
  geom_sf(aes(fill = is_expensive), color = "darkgrey", size = 0.4) +
  scale_fill_viridis_d() +
  ggtitle("Top 5 neighbourhoods with highest average price") +
  labs(fill = "Is top 5 expensive neighbourhood")
```

```{r}
relevant_columns_for_expensive_neighbourhoods <- c(
  "id", 
  "host_id",
  "price",
  "property_type", 
  "accommodates",
  "number_of_reviews"
)

print_info_for_expensive_neighbourhoods <- function(listings) {
  listings %>%
    select(relevant_columns_for_expensive_neighbourhoods) %>%
    arrange(desc(price))
}

listings_haselhorst <- listings_price_cleaned %>%
  filter(neighbourhood == 'Haselhorst')
listings_marzahn_nord <- listings_price_cleaned %>%
  filter(neighbourhood == 'Marzahn-Nord')
listings_marzahn_sud <- listings_price_cleaned %>%
  filter(neighbourhood == 'Marzahn-Süd')
listings_rummelsburger_bucht <- listings_price_cleaned %>%
  filter(neighbourhood == 'Rummelsburger Bucht')
listings_spandau_mitte <- listings_price_cleaned %>%
  filter(neighbourhood == 'Spandau Mitte')
```

```{r}
print_info_for_expensive_neighbourhoods(listings_haselhorst)
```

```{r}
boat_vector <- c("Boat", "Houseboat")

is_boat <- function(property_type) {
  property_type %in% boat_vector
}

listings_haselhorst %>%
  mutate(is_boat = is_boat(property_type)) %>%
  group_by(is_boat) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = is_boat, y = count)) +
  geom_bar(stat='identity') +
  ggtitle("Share of listings in 'Haselhorst' that are a boat") +
  xlab("Is listing a boat") +
  ylab("Number of listings")
```


Learnings from Haselhorst:
  - It only has a small number of listings
  - 70% of the listings are boats or houseboats
  - 50% of the listings belong to the same host and have an equal price
  - The most expensive listing does not have any reviews

```{r}
print_info_for_expensive_neighbourhoods(listings_marzahn_nord)
```

Learnings from Marzahn-Nord:
  - Only few listings
  - most expensive listing can be considered as outlier, since it does not have any reviews and is significantly more expensive than the other listings of the same neighbourhood

```{r}
marzahn_nord_only_with_reviews <- listings_marzahn_nord %>%
  filter(number_of_reviews > 0)
```


```{r}
print_info_for_expensive_neighbourhoods(listings_marzahn_sud)
```

```{r}
marzahn_sud_only_with_reviews <- listings_marzahn_sud %>%
  filter(number_of_reviews > 0)
print_info_for_expensive_neighbourhoods(marzahn_sud_only_with_reviews)
```

```{r}
bin_break <- 3
max_accommodates <- max(marzahn_sud_only_with_reviews$accommodates)

marzahn_sud_only_with_reviews %>%
  mutate(accommodates_bin = cut(accommodates, breaks = c(0, 3, max_accommodates))) %>%
  ggplot(aes(x = accommodates_bin, y = price)) +
  geom_boxplot() +
  ggtitle("Price span of listings in 'Marzahn-Süd' by accommodated guests") +
  xlab("Accommodated guests bin") +
  ylab("Price in $")
```

Learnings from Marzahn-Nord:
  - 4 most expensive listings highly distort the data set with a significantly higher price than the rest, despite not having any reviews
  - 4 out of 5 out of the remaining most expensive listings are serviced apartments and offered by the same host
  - the more people accommodated the higher the price

```{r}
listings_rummelsburger_bucht %>%
  ggplot(aes(x = accommodates, y = price)) +
  geom_point() +
  ggtitle("Listings in 'Rummelsburger Bucht' by accomodated guests and price") +
  xlab("Number of guests that can be accommodated") +
  ylab("Price in $")
```

```{r}
listings_rummelsburger_bucht %>%
  mutate(is_boat = is_boat(property_type)) %>%
  ggplot(aes(x = is_boat, y = price)) +
  geom_boxplot() +
  ggtitle(wrapper("Price span of boats vs. the rest of the listings in 'Rummelsburger Bucht'", width = 80)) +
  xlab("Is listing a boat?") +
  ylab("Price in $")
```

```{r}
print_info_for_expensive_neighbourhoods(listings_rummelsburger_bucht)
```

```{r}
is_entire_home <- function(property_type) {
  contains_keyword_entire <- grepl(pattern = "Entire", x = property_type, fixed = TRUE)
  is_tiny_home <- property_type == "Tiny home"
  is_boat <- is_boat(property_type)
  contains_keyword_entire | is_tiny_home | is_boat
}

listings_rummelsburger_bucht %>%
  mutate(is_entire_home = is_entire_home(property_type)) %>%
  ggplot(aes(x = is_entire_home, y = price)) +
  geom_boxplot() +
  ggtitle("Price span of entire homes vs. shared homes") +
  xlab("Is entire home?") +
  ylab("Price in $")
```

```{r}
listings_rummelsburger_bucht %>%
  mutate(is_entire_home = is_entire_home(property_type)) %>%
  group_by(is_entire_home) %>%
  summarise(count_listings = n()) %>%
  ggplot(aes(x="", y=count_listings, fill=is_entire_home)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  scale_fill_viridis_d() +
  ggtitle("Share of entire homes in Rummelsburger Bucht") +
  xlab("") +
  ylab("") +
  labs(fill = "Is entire home?")
```

Learnings from Rummelsburger Bucht:
  - most of the listings are not shared with host or other guests
  - again a lot of house boats among the most expensive listings

```{r}
is_top_5_neighbourhood <- function(neighbourhood_name) {
  neighbourhood_name %in% neighbourhoods_top_5_avg_price$neighbourhood
}

listings_only_with_reviews <- listings_price_cleaned %>%
  filter(number_of_reviews > 0)

listings_grouped_by_neighbourhood_only_with_reviews <- summarise_listings_by_neighbourhood(listings_only_with_reviews)

listings_grouped_by_neighbourhood_only_with_reviews %>%
  mutate(is_investigated_neighbourhood = is_top_5_neighbourhood(neighbourhood)) %>%
  ggplot(aes(x = count_listings, y = avg_price, shape = is_investigated_neighbourhood, colour = is_investigated_neighbourhood)) +
  geom_point() +
  ggtitle("Neighbourhoods by number of listings and average price") +
  xlab("Number of listings") +
  ylab("Average price in $") +
  labs(shape = "Is one of the investigated neighbourhoods?", colour = "Is one of the investigated neighbourhoods?")
```


```{r}
neighbourhoods_aggregated_only_with_reviews <- listings_grouped_by_neighbourhood_only_with_reviews %>%
  inner_join(berlin_neighbourhoods, by= "neighbourhood") %>%
  st_as_sf()

neighbourhoods_aggregated_only_with_reviews %>%
  ggplot() +
  geom_sf(aes(fill = avg_price), color = "white", size = 0.2) +
  scale_fill_viridis_c()
```

# If the host is not living in Berlin, how does this affect the number of offered accommodations/price/rating/...?

# If a guest submitted multiple reviews, what can we learn about their behavior?
